generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Difficulty { BEGINNER INTERMEDIATE ADVANCED }
enum LessonContentType { MARKDOWN VIDEO SLIDES INTERACTIVE EXTERNAL_LINK }
enum LabType { GUIDED OPEN_ENDED CHALLENGE }
enum LabSessionStatus { NOT_STARTED ACTIVE COMPLETED EXPIRED ABANDONED }
enum ChallengeType { QUIZ CODING MODEL_METRIC LLM_PROMPTING DESIGN_DOCUMENT }
enum ChallengeStatus { IN_PROGRESS SUBMITTED GRADED }
enum ProgressStatus { NOT_STARTED IN_PROGRESS COMPLETED }
enum EnrollmentStatus { NOT_STARTED IN_PROGRESS COMPLETED DROPPED }
enum CertificationLevel { FOUNDATION PRACTITIONER EXPERT }
enum ProgramStatus { NOT_STARTED IN_PROGRESS COMPLETED }

model Course {
  id               String   @id @default(cuid())
  organizationId   String?
  title            String
  slug             String
  shortDescription String?
  longDescription  String?
  difficulty       Difficulty
  category         String
  estimatedHours   Float?
  prerequisites    Json?
  isPublished      Boolean @default(false)
  createdByUserId  String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  modules          Module[]
  learningPathCourses LearningPathCourse[]
  skillTags        CourseSkillTag[]
  enrollments      CourseEnrollment[]
  progresses       CourseProgress[]
}

model Module {
  id          String   @id @default(cuid())
  course      Course   @relation(fields: [courseId], references: [id])
  courseId    String
  title       String
  orderIndex  Int
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lessons     Lesson[]
}

model Lesson {
  id          String   @id @default(cuid())
  module      Module   @relation(fields: [moduleId], references: [id])
  moduleId    String
  title       String
  orderIndex  Int
  contentType LessonContentType
  contentBody String
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  labs        Lab[]
  challenges  Challenge[]
  progresses  LessonProgress[]
}

model LearningPath {
  id             String   @id @default(cuid())
  organizationId String?
  title          String
  description    String?
  targetRole     String?
  estimatedHours Float?
  isPublished    Boolean @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  courses        LearningPathCourse[]
}

model LearningPathCourse {
  id             String       @id @default(cuid())
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id])
  learningPathId String
  course         Course       @relation(fields: [courseId], references: [id])
  courseId       String
  orderIndex     Int
}

model SkillTag {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  createdAt   DateTime @default(now())
  courses     CourseSkillTag[]
}

model CourseSkillTag {
  id        String   @id @default(cuid())
  course    Course   @relation(fields: [courseId], references: [id])
  courseId  String
  skillTag  SkillTag @relation(fields: [skillTagId], references: [id])
  skillTagId String
}

model Lab {
  id             String   @id @default(cuid())
  lesson         Lesson?  @relation(fields: [lessonId], references: [id])
  lessonId       String?
  organizationId String?
  title          String
  description    String?
  difficulty     Difficulty
  labType        LabType
  config         Json
  createdAt      DateTime @default(now())
  sessions       LabSession[]
}

model LabEnvironmentTemplate {
  id             String   @id @default(cuid())
  organizationId String?
  name           String
  description    String?
  config         Json
  createdAt      DateTime @default(now())
}

model LabSession {
  id             String   @id @default(cuid())
  lab            Lab      @relation(fields: [labId], references: [id])
  labId          String
  userId         String
  organizationId String
  status         LabSessionStatus @default(NOT_STARTED)
  environmentConfigSnapshot Json
  startedAt      DateTime?
  completedAt    DateTime?
  expiresAt      DateTime?
  resultSummary  Json?
}

model Challenge {
  id             String   @id @default(cuid())
  lesson         Lesson?  @relation(fields: [lessonId], references: [id])
  lessonId       String?
  course         Course?  @relation(fields: [courseId], references: [id])
  courseId       String?
  title          String
  description    String?
  challengeType  ChallengeType
  config         Json
  maxScore       Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  attempts       ChallengeAttempt[]
}

model ChallengeAttempt {
  id             String   @id @default(cuid())
  challenge      Challenge @relation(fields: [challengeId], references: [id])
  challengeId    String
  userId         String
  labSessionId   String?
  status         ChallengeStatus @default(IN_PROGRESS)
  submission     Json?
  score          Int?
  feedback       Json?
  submittedAt    DateTime?
  gradedAt       DateTime?
}

model LessonProgress {
  id             String   @id @default(cuid())
  lesson         Lesson   @relation(fields: [lessonId], references: [id])
  lessonId       String
  userId         String
  status         ProgressStatus @default(NOT_STARTED)
  completedAt    DateTime?
  lastAccessedAt DateTime?
}

model CourseEnrollment {
  id             String   @id @default(cuid())
  course         Course   @relation(fields: [courseId], references: [id])
  courseId       String
  userId         String
  organizationId String
  status         EnrollmentStatus @default(NOT_STARTED)
  startedAt      DateTime @default(now())
  completedAt    DateTime?
}

model CourseProgress {
  id             String   @id @default(cuid())
  course         Course   @relation(fields: [courseId], references: [id])
  courseId       String
  userId         String
  organizationId String
  progressPercent Float @default(0)
  lastUpdatedAt  DateTime @default(now())
}

model Certification {
  id             String   @id @default(cuid())
  code           String   @unique
  name           String
  description    String?
  level          CertificationLevel
  requirements   Json
  isPublished    Boolean @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userCerts      UserCertification[]
}

model UserCertification {
  id             String   @id @default(cuid())
  certification  Certification @relation(fields: [certificationId], references: [id])
  certificationId String
  userId         String
  organizationId String
  status         String
  earnedAt       DateTime?
  expiresAt      DateTime?
  evidence       Json?
}

model Badge {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  iconUrl     String?
  criteria    Json
  userBadges  UserBadge[]
}

model UserBadge {
  id             String   @id @default(cuid())
  badge          Badge    @relation(fields: [badgeId], references: [id])
  badgeId        String
  userId         String
  organizationId String
  earnedAt       DateTime @default(now())
}

model LearningProgram {
  id               String   @id @default(cuid())
  organizationId   String
  name             String
  description      String?
  targetRoles      Json?
  requiredLearningPathIds Json?
  suggestedTimeline String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  enrollments      UserProgramEnrollment[]
}

model UserProgramEnrollment {
  id                String   @id @default(cuid())
  learningProgram   LearningProgram @relation(fields: [learningProgramId], references: [id])
  learningProgramId String
  userId            String
  status            ProgramStatus @default(NOT_STARTED)
  startedAt         DateTime?
  completedAt       DateTime?
}

// Extend existing LlmAgent with tutor flag
model LlmAgent {
  id             String       @id @default(cuid())
  organizationId String
  // ... other fields from existing schema ...
  isTutor        Boolean @default(false)
}

// Extend projects/workspaces for sandbox flag
model Workspace {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  isTrainingSandbox Boolean @default(false)
  // ... other fields from existing schema ...
}

model Project {
  id             String   @id @default(cuid())
  organizationId String
  workspaceId    String?
  name           String
  slug           String
  isTrainingSandbox Boolean @default(false)
  // ... other fields from existing schema ...
}
